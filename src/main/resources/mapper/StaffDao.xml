<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qiein.erp.pk.web.dao.StaffDao" >

    <select id="selectStaffByGroupId" resultType="com.qiein.erp.pk.web.entity.vo.StaffSelectVO">
        SELECT
            staff.ID id,
            staff.NICKNAME nickName,
            staff.USERNAME staffName,
            staff.PHONE phone,
            staff.HEADIMG headImg,
            ifnull(
                GROUP_CONCAT(role.role_id SEPARATOR ","),
                ''
            ) roleIds
        FROM
            hm_pub_group_staff group_staff
        LEFT JOIN hm_pub_staff staff ON staff.id = group_staff.STAFFID
        AND staff.COMPANYID = group_staff.COMPANYID
        LEFT JOIN hm_erp_staff_role role ON group_staff.STAFFID = role.staff_id
        AND group_staff.COMPANYID = role.company_id
        WHERE
            group_staff.COMPANYID = #{companyId}
        AND group_staff.groupid =#{groupId}
        AND staff.ISDEL = 0
        GROUP BY
            group_staff.STAFFID
    </select>
    <select id="findVenueByGroupId"  resultType="com.qiein.erp.pk.web.entity.vo.StaffSelectVO">
        SELECT
        staff.ID id,
        ifnull(
        GROUP_CONCAT(
        staff_venue.venue_id SEPARATOR ","
        ),
        ''
        ) venueIds,
        ifnull(
        GROUP_CONCAT(
        venue.venue_name SEPARATOR ","
        ),
        ''
        ) venueNames
        FROM
        hm_pub_group_staff group_staff
        LEFT JOIN hm_pub_staff staff ON staff.id = group_staff.STAFFID
        AND staff.COMPANYID = group_staff.COMPANYID
        LEFT JOIN hm_erp_staff_venue staff_venue ON staff_venue.staff_id = group_staff.STAFFID
        AND staff_venue.company_id = group_staff.COMPANYID
        LEFT JOIN hm_erp_venue venue ON venue.id = staff_venue.venue_id
        AND venue.company_id = staff_venue.company_id
        WHERE
        group_staff.COMPANYID = #{companyId}
        AND group_staff.groupid = #{groupId}
        AND staff.ISDEL = 0
        GROUP BY
        group_staff.STAFFID
    </select>
    <select id="checkHave" resultType="Integer">
        select staff_id from hm_erp_staff staff where staff.staff_id in(#{staffIds})
    </select>
    <insert id="insertToStaff">
        replace into hm_erp_staff(staff_id,staff_status,company_id,create_time,update_time) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.staffId},#{item.status},#{item.companyId} ,UNIX_TIMESTAMP(now()),UNIX_TIMESTAMP(now()))
        </foreach>
    </insert>
    <delete id="deleteVenue">
        delete from hm_erp_staff_venue where staff_id in (${staffIds})
    </delete>
    <delete id="deleteRole">
        delete from hm_erp_staff_role where staff_id in (${staffIds})
    </delete>
    <insert id="insertVenue">
        insert into hm_erp_staff_venue(staff_id,venue_id,company_id)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.staffId},#{item.venueId},#{item.companyId})
        </foreach>
    </insert>
    <insert id="insertRole">
        insert into hm_erp_staff_role(staff_id,role_id,company_id)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.staffId},#{item.roleId},#{item.companyId})
        </foreach>
    </insert>
    <resultMap id="producerMap" type="com.qiein.erp.pk.web.entity.vo.StaffRoleTypeVO">
        <result property="staffId" column="staff_id"/>
        <result property="venueId" column="venue_id"/>
        <result property="staffName" column="NICKNAME"/>
        <result property="phone" column="PHONE"/>
        <result property="roleLevel" column="role_level"/>
        <result property="roleId" column="role_id"/>
        <result property="companyId" column="company_id"/>

    </resultMap>
    <select id="selectProducer" resultMap="producerMap">
        SELECT
            venue.staff_id,
            staff.NICKNAME,
            staff.PHONE,
            venue_id,
            role_level,
            role_id,
            venue.company_id
        FROM
            hm_erp_staff_venue venue
        LEFT JOIN hm_pub_staff staff ON venue.staff_id = staff.ID
        AND venue.company_id = staff.COMPANYID
        LEFT JOIN hm_erp_staff_role role ON role.staff_id = venue.staff_id
        AND role.company_id = venue.company_id
        WHERE
            venue.company_id = #{companyId}
        AND role.role_id = #{roleId}
    </select>
    <update id="editRoleLevel">
        update hm_erp_staff_role set role_level=#{roleLevel} where company_id=#{companyId} and staff_id=#{staffId} and role_id=#{roleId}
    </update>
</mapper>