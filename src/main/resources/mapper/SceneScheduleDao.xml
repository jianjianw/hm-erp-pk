<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qiein.erp.pk.web.dao.SceneScheduleDao" >

    <resultMap id="BaseResultMap" type="com.qiein.erp.pk.web.entity.po.SceneSchedulePO" >
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="shoot_id" property="shootId" jdbcType="INTEGER" />
        <result column="scene_id" property="sceneId" jdbcType="INTEGER" />
        <result column="start_time" property="startTime" jdbcType="INTEGER" />
        <result column="end_time" property="endTime" jdbcType="INTEGER" />
        <result column="end_time" property="endTime" jdbcType="INTEGER" />
        <result column="status_id" property="statusId" jdbcType="VARCHAR" />
        <result column="company_id" property="companyId" jdbcType="INTEGER" />
        <result column="venue_id" property="venueId" jdbcType="INTEGER" />
    </resultMap>

    <resultMap id="sceneSchedule" type="com.qiein.erp.pk.web.entity.po.SceneSchedulePO">
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="shoot_id" property="shootId" jdbcType="INTEGER" />
        <result column="scene_id" property="sceneId" jdbcType="INTEGER" />
        <result column="start_time" property="startTime" jdbcType="INTEGER" />
        <result column="end_time" property="endTime" jdbcType="INTEGER" />
        <result column="end_time" property="endTime" jdbcType="INTEGER" />
        <result column="status_id" property="statusId" jdbcType="VARCHAR" />
        <result column="company_id" property="companyId" jdbcType="INTEGER" />
        <result column="venue_id" property="venueId" jdbcType="INTEGER" />
        <result column="order_id" property="orderId" jdbcType="INTEGER"/>
        <association property="staffVO" javaType="com.qiein.erp.pk.web.entity.vo.StaffVO">
            <result column="id" property="id"></result>
            <result column="NICKNAME" property="nickName"></result>
        </association>

    </resultMap>

    <select id="selectSceneScheduleByDate" parameterType="map" resultMap="sceneSchedule">
      select scene.id,scene.shoot_id,scene.scene_id,scene.start_time,scene.end_time,scene.status_id,scene.company_id,scene.venue_id,
                                                                                        staff.id ,staff.NICKNAME,order_process.order_id
          from hm_erp_scene_schedule scene
          inner join hm_erp_process_scene_schedule scene_link on scene.id = scene_link.shoot_schedule_id
          and scene.company_id = scene_link.company_id

          inner join hm_erp_process_shoot_schedule shoot_link on shoot_link.process_id = scene_link.process_id
          and shoot_link.company_id = scene_link.company_id

          inner join hm_erp_staff_schedule staff_schedule on staff_schedule.id = shoot_link.shoot_schedule_id
          and staff_schedule.company_id = shoot_link.company_id

          inner join hm_pub_staff staff on staff.ID = staff_schedule.staff_id
          and staff.COMPANYID = staff_schedule.company_id

          left join hm_erp_order_process order_process on order_process.order_id = scene_link.process_id
          and order_process.company_id = scene_link.company_id

      where scene.company_id = #{companyId}
      and scene.start_time BETWEEN #{startTime} AND #{endTime}
        <if test="venueId != null">
            and  scene.venue_id = #{venueId}
        </if>
    </select>



    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from hm_erp_scene_schedule
    where id = #{id,jdbcType=INTEGER}
  </delete>

    <insert id="insert" parameterType="com.qiein.erp.pk.web.entity.po.SceneSchedulePO" >
    insert into hm_erp_scene_schedule (id, shoot_id, scene_id,
      start_time, end_time, status_id,
      company_id, venue_id)
    values (#{id,jdbcType=INTEGER}, #{shootId,jdbcType=INTEGER}, #{sceneId,jdbcType=INTEGER},
      #{startTime,jdbcType=INTEGER}, #{endTime,jdbcType=INTEGER}, #{statusId,jdbcType=SMALLINT},
      #{companyId,jdbcType=INTEGER}, #{venueId,jdbcType=INTEGER})
  </insert>

    <update id="updateByPrimaryKey" parameterType="com.qiein.erp.pk.web.entity.po.SceneSchedulePO" >
    update hm_erp_scene_schedule
    set shoot_id = #{shootId,jdbcType=INTEGER},
      scene_id = #{sceneId,jdbcType=INTEGER},
      start_time = #{startTime,jdbcType=INTEGER},
      end_time = #{endTime,jdbcType=INTEGER},
      status_id = #{statusId,jdbcType=SMALLINT},
      company_id = #{companyId,jdbcType=INTEGER},
      venue_id = #{venueId,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>

    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select id, shoot_id, scene_id, start_time, end_time, status_id, company_id, venue_id
    from hm_erp_scene_schedule
    where id = #{id,jdbcType=INTEGER}
  </select>

    <select id="selectAll" resultMap="BaseResultMap" >
    select id, shoot_id, scene_id, start_time, end_time, status_id, company_id, venue_id
    from hm_erp_scene_schedule
  </select>


    <update id="punchIn" parameterType = "map">
      update hm_erp_scene_schedule set
       status_id = #{statusId}
      where
       company_id = #{companyId}
       and id = #{id}
    </update>

    <resultMap id="orderMap" type="com.qiein.erp.pk.web.entity.vo.OrderVO">
        <id property="id" column="id"/>
        <result property="orderTime" column="order_time"/>
        <result property="shootTime" column="venue_day"/>
        <result property="planTime" column="staff_day"/>
        <result property="kzPhone" column="KZPHONE"/>
        <result property="kzName" column="KZNAME"/>
        <result property="mateName" column="MATENAME"/>
        <result property="matePhone" column="MATEPHONE"/>
        <result property="address" column="ADDRESS"/>
        <result property="venueId" column="venue_id"/>
        <result property="mealId" column="meal_id"/>
        <result property="mealName" column="meal_name"/>
        <result property="orderType" column="order_type"/>
        <result property="shootId" column="shoot_id"/>
        <result property="shootName" column="shoot_name"/>
        <result property="makeupId" column="makeup_id"/>
        <result property="makeupName" column="makeup_name"/>
        <result property="shootRoomId" column="shootRoomId"/>
    </resultMap>

    <select id="findOrderBySceneScheduleId" parameterType="map" resultMap="orderMap">

        select erp_order.id,erp_order.kzid,erp_order.order_num,erp_order.meal_id,erp_order.company_id,
        from hm_erp_scene_schedule scene_schedule

        inner join hm_erp_process_scene_schedule scene_process on scene_schedule.id = process.shoot_schedule_id
        and scene_schedule.company_id = scene_process.company_id

        inner join hm_erp_order_process order_process on order_process.id = scene_process.process_id
        and order_process.company_id = scene_process.company_id

        inner join hm_erp_order erp_order on erp_order.id = order_process.order_id
        and erp_order.company_id = order_process.company_id

        inner join hm_crm_client_info info on info.KZID = erp_order.kzid
        and info.COMPANYID = erp_order.company_id;







        where scene_schedule.company_id = #{companyId}
        and scene_schedule.id = #{id}



    </select>
</mapper>